<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=generator content="Relearn 5.12.3"><meta name=description content><meta name=author content="Choria Project"><title>V2 Protocol & Security :: Choria Server and Broker</title><link href=https://choria-io.github.io/go-choria/previews/protov2/index.xml rel=alternate type=application/rss+xml title="V2 Protocol & Security :: Choria Server and Broker"><link href=https://choria-io.github.io/go-choria/css/fontawesome-all.min.css?1681207470 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/fontawesome-all.min.css?1681207470 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/nucleus.css?1681207470 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/auto-complete.css?1681207470 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/auto-complete.css?1681207470 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/perfect-scrollbar.min.css?1681207470 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/fonts.css?1681207470 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/fonts.css?1681207470 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/theme.css?1681207470 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/theme-choria-relearn.css?1681207470 rel=stylesheet id=variant-style><link href=https://choria-io.github.io/go-choria/css/variant.css?1681207470 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/print.css?1681207470 rel=stylesheet media=print><link href=https://choria-io.github.io/go-choria/css/ie.css?1681207470 rel=stylesheet><script src=https://choria-io.github.io/go-choria/js/url.js?1681207470></script>
<script src=https://choria-io.github.io/go-choria/js/variant.js?1681207470></script>
<script>window.index_json_url="https://choria-io.github.io/go-choria/index.json";var root_url="https://choria-io.github.io/go-choria/",baseUriFull,baseUri=root_url.replace(/\/$/,'');window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \u0022{0}\u0022",window.T_N_results_found="{1} results found for \u0022{0}\u0022",baseUriFull="https://choria-io.github.io/go-choria/",window.variants&&variants.init(["choria-relearn"])</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=https://choria-io.github.io/go-choria/previews/protov2/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div class=navigation><span class="nav nav-next topbar-link"><i class="fa fa-chevron-right fa-fw"></i></span></div><div class=navigation><a class="nav nav-prev topbar-link" href=https://choria-io.github.io/go-choria/previews/index.html title="Tech Previews (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title="Menu (CTRL+ALT+n)"><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title="Table of Contents (CTRL+ALT+t)"><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/go-choria/index.html><span itemprop=name>Choria Server and Broker</span></a><meta itemprop=position content="1">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/go-choria/previews/index.html><span itemprop=name>Tech Previews</span></a><meta itemprop=position content="2">></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>V2 Protocol & Security</span><meta itemprop=position content="3"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#requirements>Requirements</a></li><li><a href=#security-credentials>Security Credentials</a></li><li><a href=#deployment-methods>Deployment Methods</a></li><li><a href=#decentralized-deployment>Decentralized deployment</a></li><li><a href=#self-provisioned-and-aaa-integrated-deployment>Self Provisioned and AAA Integrated Deployment</a></li><li><a href=#vault-as-organization-issuer>Vault as Organization Issuer</a></li></ul></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><div id=head-tags></div><article class=default><h1 id=v2-protocol--security>V2 Protocol & Security</h1><p>This is a guide for early adopters who wish to test and study the <a href=https://choria-io.github.io/go-choria/adr/001/>Version 2 Protocol and Security</a> project.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>This is a <em>Hard Mode</em> guide that does everything manually and with no Configuration Management.</p></div></div><h3 id=requirements>Requirements</h3><ul><li>Choria Nightly</li><li><a href=https://choria-io.github.io/aaasvc/ target=_blank>Choria AAA Service</a> Nightly</li><li><a href=https://choria-io.github.io/provisioner/ target=_blank>Choria Provisioner</a> Nightly</li><li>Docker on Intel CPU</li></ul><h3 id=security-credentials>Security Credentials</h3><p>Security is by means of a ed25519 key that signs JWTs, some JWTs form a chain and can sign others. Regardless of the signer verification can be done using the public key associated with the Organization Issuer.</p><p><a href=#image-e68422625ad8d976767b80166a8e8e01 class=lightbox-link><img src=https://choria-io.github.io/go-choria/org-issuers.png alt="Chain Issuers" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-e68422625ad8d976767b80166a8e8e01><img src=https://choria-io.github.io/go-choria/org-issuers.png alt="Chain Issuers" class=lightbox-image loading=lazy></a></p><p>The Organization Issuer can be kept offline with Provisioning and AAA being delegated authorities capable of signing servers and clients but these are optional components - the Organization Issuer can directly sign Clients and Servers allowing them to operate without the other central components.</p><h3 id=deployment-methods>Deployment Methods</h3><p>We demonstrate two deployment methods:</p><ul><li><a href=#decentralized-deployment>Decentralized</a> - like traditional Choria with only a broker as shared component</li><li><a href=#self-provisioned-and-aaa-integrated-deployment>Centralized AAA and Provisioning</a> - uses Choria AAA Service and Choria Provisioner for low-touch auto enrolment of Clients and Servers</li></ul><p>Additionally, we show how Hashicorp Vault can be integrated to <a href=#vault-as-organization-issuer>manage the Organization Issuer</a></p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>We recommend reviewers really dig into the details here, we do have a <a href=https://github.com/ripienaar/choria-compose target=_blank>Docker Compose environment</a> with this all setup.</p></div></div><h3 id=decentralized-deployment>Decentralized deployment</h3><p>In this model we will deploy a system that resembles the basic architecture diagram below</p><p><a href=#image-21763d6c162a98f7fefce693b7c395bc class=lightbox-link><img src=https://choria.io/docs/basic_client_server_overview.png alt=Architecture style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-21763d6c162a98f7fefce693b7c395bc><img src=https://choria.io/docs/basic_client_server_overview.png alt=Architecture class=lightbox-image loading=lazy></a></p><p>We have only the Brokers as central architecture with no Central AAA or Provisioning.</p><p>We will not use mTLS in this case. mTLS is supported but a major advantage of this mode is that it&rsquo;s not required.</p><h4 id=docker>Docker</h4><p>We will need two Docker networks and 3 instances - broker, server, client and issuer.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ docker network create choria_v2proto
$ docker network create choria_issuer
$ docker pull registry.choria.io/choria-nightly/choria:nightly
$ docker run -ti --rm --entrypoint bash \
      --network choria_v2proto \
      --hostname broker.example.net \
      registry.choria.io/choria-nightly/choria:nightly -l
$ docker run -ti --rm --entrypoint bash \
      --network choria_v2proto \
      --hostname server.example.net \
      registry.choria.io/choria-nightly/choria:nightly -l
$ docker run -ti --rm --entrypoint bash \
      --network choria_v2proto \
      --hostname client.example.net \
      registry.choria.io/choria-nightly/choria:nightly -l
$ docker run -ti --rm --entrypoint bash \
      --network choria_issuer \
      --hostname issuer.example.net registry.choria.io/choria-nightly/choria:nightly -l
</code></pre><p>The issuer is not needed per-se but will demonstrate that the Issuer credentials never need to near the managed network.</p><h4 id=keys-and-jwts>Keys and JWTs</h4><p>In this Scenario we need:</p><ul><li>An Organization Issuer keypair</li><li>A client JWT for each user</li><li>A server JWT for each server</li><li>x509 certificate for the broker TLS port</li></ul><p>In this scenario you are responsible for creating and distributing the keys and tokens.</p><h5 id=organization-issuer>Organization Issuer</h5><p>The Organization Issuer is the root of the Trust Chain and is a ed25519 key, let&rsquo;s create the keypair on the issuer node:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ mkdir -p development/issuer
[choria@issuer ~]$ choria jwt keys development/issuer/private.key development/issuer/public.key
Public Key: b3989a299278750427b00213693c2ca02146476a361667682446230842836da8

Ed25519 seed saved in development/issuer/private.key
</code></pre><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>This key should be kept private and ideally in a Hashicorp Vault server. See a later section for guidance on Vault.</p></div></div><h5 id=broker-jwt-and-config>Broker JWT and Config</h5><p>Every broker needs a ed25519 Keypair and a signed JWT.</p><p>First we create a keypair on the broker, the private key never leaves the broker:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@broker ~]$ choria jwt keys /etc/choria/private.key /etc/choria/public.key
Public Key: 8918c1c7a4aeb4d4ad16729dc9b9c12df021d9296106eb5f072b224aa8f8eee9

Ed25519 seed saved in /etc/choria/private.key
</code></pre><p>Pass the Public Key to the Organization Issuer who creates a JWT:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ mkdir -p development/broker/broker.example.net
[choria@issuer ~]$ choria jwt server development/broker/broker.example.net/token.jwt \
broker.example.net \
8918c1c7a4aeb4d4ad16729dc9b9c12df021d9296106eb5f072b224aa8f8eee9 \
development/issuer/private.key \
--collectives=choria
</code></pre><p>With access to just the Broker public key the Organization Issuer can create a server token, pass this back to the server who stores it in <code>/etc/choria/broker.jwt</code>.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>Note that for version 2 protocol the default collective is <code>["choria"]</code>.</p></div></div><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ choria jwt development/broker/broker.example.net/token.jwt development/issuer/public.key
Validated Server Token development/server/server.example.net/token.jwt

             Identity: server.example.net
           Expires At: 2023-12-08 13:03:23 +0000 UTC (364d23h59m41s)
          Collectives: choria
           Public Key: 8918c1c7a4aeb4d4ad16729dc9b9c12df021d9296106eb5f072b224aa8f8eee9
    Organization Unit: choria
   Private Network ID: 92328d88bef9d063480fd4b0ec5e4879

   Broker Permissions:

          No server specific permissions granted
</code></pre><p>We pass the JWT back to the broker and save in <code>/etc/choria/broker.jwt</code>.</p><p>The broker need x509 certificates to open the TLS network port, here we just self-sign one but you can get those from anywhere.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@broker ~]$ openssl genrsa -out /etc/choria/broker-tls.key 2048
Generating RSA private key, 2048 bit long modulus (2 primes)
..+++++
....................................................................................................+++++
e is 65537 (0x010001)
[choria@broker ~]$ openssl req -new -x509 -sha256 -key /etc/choria/broker-tls.key \
   -out /etc/choria/broker-tls.cert -days 365 -subj &#34;/O=Choria.io/CN=broker.example.net&#34;
</code></pre><p>With all in place it should look like this:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@broker ~]$ find /etc/choria/
/etc/choria/
/etc/choria/broker.conf
/etc/choria/broker-tls.key
/etc/choria/broker-tls.cert
/etc/choria/private.key
/etc/choria/public.key
/etc/choria/broker.jwt
</code></pre><p>We create the broker configuration in <code>/etc/choria/broker.conf</code> and start it, you need to change your issuer here:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># The name of the organization to configure, for now only supports choria
plugin.security.issuer.names = choria

# The public key from the issuer
plugin.security.issuer.choria.public = b3989a299278750427b00213693c2ca02146476a361667682446230842836da8

# Configures access to broker internal statistics and more
plugin.choria.network.system.password = sYst3m

# Used later in the Provisioner based setup
plugin.choria.network.provisioning.client_password = s3cret

plugin.choria.stats_port = 8222
plugin.choria.broker_network = true
plugin.choria.network.client_port = 4222
plugin.choria.network.stream.store = /data
plugin.choria.network.system.user = system
loglevel = info
plugin.choria.use_srv = false

plugin.security.provider = choria
plugin.security.choria.certificate = /etc/choria/broker-tls.cert
plugin.security.choria.key = /etc/choria/broker-tls.key
plugin.security.choria.token_file = /etc/choria/broker.jwt
plugin.security.choria.seed_file = /etc/choria/private.key
</code></pre><p>Let&rsquo;s start the broker, showing the key lines from the output here:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria broker run --config /etc/choria/broker.conf
INFO[0000] Choria Broker version 0.99.0.20221201 starting with config /etc/choria/broker.conf
INFO[0000] Starting Network Broker
WARN[0000] Allowing unverified TLS connections for Organization Issuer issued connections  component=network
WARN[0000] Loaded Organization Issuer choria with public key b3989a299278750427b00213693c2ca02146476a361667682446230842836da8  component=network
INFO[0000] Listening for client connections on [::]:4222  component=network_broker
...
</code></pre><h5 id=server-jwt>Server JWT</h5><p>Every server needs a ed25519 Keypair and a signed JWT.</p><p>The server process is identical to the broker process except change <code>broker.example.net</code> to <code>server.example.net</code> in identities and make obvious file name changes. Servers do not need any x509 certificates like brokers.</p><p>Now we can configure and start the server, place this in <code>/etc/choria/server.conf</code>:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># The name of the organization to configure, for now only supports choria
plugin.security.issuer.names = choria

# The public key from the issuer
plugin.security.issuer.choria.public = b3989a299278750427b00213693c2ca02146476a361667682446230842836da8

# We enable authorization and set it to trust the JWT tokens policy
rpcauthorization = 1
rpcauthprovider = aaasvc

plugin.security.provider = choria
plugin.security.choria.token_file = /etc/choria/server.jwt
plugin.security.choria.seed_file = /etc/choria/private.key
plugin.choria.middleware_hosts = nats://broker.example.net:4222
</code></pre><p>And finally let&rsquo;s run the server, showing key log lines only:</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>Servers usually run as root, here as the <code>choria</code> user as it&rsquo;s in the container</p></div></div><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@server ~]$ choria server run --config /etc/choria/server.conf
INFO[0000] Choria Server version 0.99.0.20221201 starting with config /etc/choria/server.conf using protocol version 2
INFO[0000] Setting JWT token and unique reply queues based on JWT for &#34;server.example.net&#34;  component=server connection=server.example.net identity=server.example.net
INFO[0000] Setting custom inbox prefix based on unique ID to choria.reply.77e64440ac709c0836487e5b77334e5b  component=server connection=server.example.net identity=server.example.net
</code></pre><h6 id=client-jwt>Client JWT</h6><p>Every client needs a ed25519 keypair and a signed JWT.</p><p>We will create a client that has access to Choria Streams and the ability to manage the fleet without any AAA Server.</p><p>The client will create their own keypair, so we run that in the client node:</p><pre tabindex=0><code class=language-noghighlight data-lang=noghighlight>[choria@client ~]$ mkdir -p ~/.config/choria/
[choria@client ~]$ choria jwt keys ~/.config/choria/private.key ~/.config/choria/public.key
Public Key: 4bbfddb9f70f4b39f5b13bac8e83a9a31c3af49e388da86a666f8615101bc818

Ed25519 seed saved in /home/choria/.config/choria/private.key
</code></pre><p>This client <code>private.key</code> should be kept private and not shared, the JWT can be created with knowledge of the public key only.</p><p>The client pass their Public Key to the Organization Issuer who creates a JWT on the Issuer node:</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>Here we use <code>choria</code> as the identity, this would match the unix user name.</p><p>If a user is on many machines, create a JWT per machine.</p></div></div><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ mkdir -p development/client/choria
[choria@issuer ~]$ choria jwt client development/client/choria/token.jwt choria development/issuer/private.key \
 --public-key 4bbfddb9f70f4b39f5b13bac8e83a9a31c3af49e388da86a666f8615101bc818 \
 --stream-admin \
 --event-viewer \
 --elections-user \
 --service \
 --fleet-management \
 --agents &#39;*&#39; \
 --validity 1y
Saved token to development/client/choria/token.jwt, use &#39;choria jwt view development/client/choria/token.jwt&#39; to view it
</code></pre><p>With access to the Issuer private key, but not the user private key, we can create a JWT for the user. Since we have no AAA Service we mark this user as a <code>service</code> which allows them to have a long token validity. We set a policy allowing all agent access, in real life this would be an Open Policy Agent policy.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ choria jwt development/client/choria/token.jwt development/issuer/public.key
Validated Client Identification Token development/client/choria/token.jwt

          Caller ID: choria
  Organization Unit: choria
     Allowed Agents: *
         Public Key: 4bbfddb9f70f4b39f5b13bac8e83a9a31c3af49e388da86a666f8615101bc818
 Private Network ID: 0a63c70a8817f5ef4d19d055ce6513f1
         Expires At: 2023-12-08 12:54:07 +0000 UTC (364d23h59m19s)

 Client Permissions:

      Can manage Choria fleet nodes
      Can use Leader Elections
      Can view Lifecycle and Autonomous Agent events
      Can administer Choria Streams
      Can access the Broker system account
      Can have an extended token lifetime
</code></pre><p>Pass the JWT back to the client who saves it in <code>~/.config/choria/token.jwt</code>.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@client ~]$ find ~/.config
/home/choria/.config
/home/choria/.config/choria
/home/choria/.config/choria/private.key
/home/choria/.config/choria/public.key
/home/choria/.config/choria/token.jwt
</code></pre><p>We create a system-wide client configuration in <code>/etc/choria/client.conf</code>:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>loglevel = warn
plugin.choria.middleware_hosts = broker.example.net:4222
plugin.choria.network.system.user = system
plugin.choria.network.system.password = sYst3m

plugin.security.provider = choria
plugin.security.choria.token_file = ~/.config/choria/token.jwt
plugin.security.choria.seed_file = ~/.config/choria/private.key
</code></pre><p>We can now test the client:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@client ~]$ choria ping
server.example.net                       time=3 ms

---- ping statistics ----
1 replies max: 4ms min: 4ms avg: 4ms overhead: 12ms
</code></pre><p>Other commands like <code>choria req choria_util info</code> should work demonstrating authorization works and <code>choria broker server list</code> should list the broker indicating Broker System Account access works. After a minute or so <code>choria broker stream ls</code> will show a list of Streams demonstrating Choria Streams authority worked.</p><h3 id=self-provisioned-and-aaa-integrated-deployment>Self Provisioned and AAA Integrated Deployment</h3><p>Thus far we had to manually sign and configure every single server and client, we had to copy files around and more, it&rsquo;s all a bit tedious.</p><p>Lets see how Choria can configure itself and how user management can be centralized for self-service user enrollment.</p><ul><li>Instead of signing Server JWTs servers will go to <a href=https://choria-io.github.io/provisioner/ target=_blank>Choria Provisioner</a> to obtain credentials and configuration</li><li>Instead of issuing Client JWTs for every user that are long-lasting we will use a central authorization flow to issue short-lived JWTs and distribute them</li></ul><p><a href=#image-61fafebbf9db3ebae2b28d9f68d7be0a class=lightbox-link><img src=https://choria-io.github.io/go-choria/protov2-centralized.png alt="Centralized Deployment" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox id=image-61fafebbf9db3ebae2b28d9f68d7be0a><img src=https://choria-io.github.io/go-choria/protov2-centralized.png alt="Centralized Deployment" class=lightbox-image loading=lazy></a></p><h4 id=docker-1>Docker</h4><p>We will create re-use the networks we made before, and we can keep the same <code>issuer.example.net</code> and <code>broker.example.net</code>.</p><p>So stop and recreate your server and client containers, we&rsquo;ll 2 more container during the guide.</p><h4 id=issuer>Issuer</h4><p>The issuer is unchanged from before, so just follow the same steps as before or keep the one you have if you followed the Decentralized section.</p><h4 id=broker>Broker</h4><p>The broker is unchanged from before, so just follow the same steps as before or keep the one you have if you followed the earlier Decentralized section.</p><p>You will note we have a setting in the <code>broker.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.provisioning.client_password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>s3cret</span>
</span></span></code></pre></div><p>This instructs the broker that we will be connecting servers needing provisioning to it. You should see a log line like:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>WARN[0000] Allowing Provisioner connections subject to JWT claims  component=network
</code></pre><h4 id=provisioner>Provisioner</h4><p>The <a href=https://choria-io.github.io/provisioner/ target=_blank>Choria Provisioner</a> is a service that configures new Choria Servers:</p><ul><li>Enrolls servers into the Issuer</li><li>Create a per-node configuration</li><li>Deploys Open Policy Agent policies</li><li>Configures the server</li><li>Optionally perform version upgrades</li></ul><p>We have CLI tooling allowing you to re-provision servers on demand and more. Review its documentation for full detail.</p><p>It needs to connect to the broker, so it needs JWT token, let&rsquo;s create the container and create the private key:</p><p>Since the container does not have the <code>choria</code> command we have to jump some hoops, we&rsquo;ll make a local storage directory for its configuration and keys and then mount that in.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ mkdir provisioner
host$ docker run -v `pwd`/provisioner:/etc/choria-provisioner --user root --entrypoint bash --rm -ti registry.choria.io/choria-nightly/choria:nightly -l
[root@5d96691fa69f /]# choria jwt keys /etc/choria-provisioner/private.key /etc/choria-provisioner/public.key
Public Key: a8c15c0a4bbae0646d0c5aa92513f4d58c2c0e51464b4b267bb3a42dbebd1c8a
[root@5d96691fa69f /]# chown -R choria:choria /etc/choria-provisioner/
[root@5d96691fa69f /]# exit
</code></pre><p>Next we create a provisioner JWT and save it in <code>provisioner/token.jwt</code></p><pre tabindex=0><code class=language-nohightlight data-lang=nohightlight>[choria@issuer ~]$ mkdir -p development/provisioner
[choria@issuer ~]$ choria jwt client development/provisioner/token.jwt provisioner_signer development/issuer/private.key \
    --public-key a8c15c0a4bbae0646d0c5aa92513f4d58c2c0e51464b4b267bb3a42dbebd1c8a \
    --server-provisioner \
    --validity 365d \
    --issuer
</code></pre><p>Here we create a token that has access to the NATS Account new machines will join, it&rsquo;s a year valid and it can issue new credentials.</p><p>Place the <code>development/provisioner/token.jwt</code> on your host in <code>provisioner/token.jwt</code>, next to <code>private.key</code> and <code>public.key</code> we made above.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>We will not delve much into the Provisioner configuration details, <a href=https://choria-io.github.io/provisioner/ target=_blank>visit its documentation site</a> for details.</p></div></div><p>We need to configure how the Provisioner use these files, create <code>provisioner/client.cfg</code> on your host:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.security.provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.token_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/choria-provisioner/token.jwt</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.seed_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/choria-provisioner/private.key</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>identity</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>provisioner_signer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.middleware_hosts</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>nats://broker.example.net:4222</span>
</span></span></code></pre></div><p>Next we create the Provisioner configuration file in <code>provisioner/choria-provisioner.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># The issuer public key</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jwt_verify_cert</span>: <span style=color:#ae81ff>b3989a299278750427b00213693c2ca02146476a361667682446230842836da8</span>
</span></span><span style=display:flex><span><span style=color:#f92672>interval</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logfile</span>: <span style=color:#ae81ff>/dev/stdout</span>
</span></span><span style=display:flex><span><span style=color:#f92672>loglevel</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span><span style=color:#f92672>helper</span>: <span style=color:#ae81ff>/etc/choria-provisioner/helper.rb</span>
</span></span><span style=display:flex><span><span style=color:#f92672>token</span>: <span style=color:#ae81ff>s3cret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>choria_insecure</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>site</span>: <span style=color:#ae81ff>PREVIEW</span>
</span></span><span style=display:flex><span><span style=color:#f92672>broker_provisioning_password</span>: <span style=color:#ae81ff>s3cret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jwt_signing_key</span>: <span style=color:#ae81ff>private.key</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jwt_signing_token</span>: <span style=color:#ae81ff>token.jwt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>features</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>jwt</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ed25519</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Next we need the script that generates per-node configuration, store the <a href=helper.rb>helper.rb</a> in <code>provisioner/helper.rb</code> and change the <code>ISSUER</code> constant near the top.</p><pre tabindex=0><code class=language-nohightlight data-lang=nohightlight>host$ vi provisioner/helper.rb
host$ chmod a+x provisioner/helper.rb
host$ sudo chown -R 2048:2048 provisioner
</code></pre><p>We can now run our Provisioner:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ docker run -ti --rm -v `pwd`/provisioner:/etc/choria-provisioner \
    --network choria_v2proto \
    --hostname provisioner.example.net \
    choria/provisioner:nightly
</code></pre><h4 id=servers>Servers</h4><p>For servers, we are going to need the RPM (already in the container) and a new file <code>/etc/choria/provisioning.jwt</code>. This is read by the server process and tells it to enter provisioning mode.</p><p>The JWT file is basically just a configuration file signed by our Issuer. The server reads it unvalidated but the Provisioner will ensure the incoming server holds the token signed by our Issuer.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ choria jwt prov development/server/provisioning.jwt \
    development/issuer/private.key \
    --token s3cret \
    --urls nats://broker.example.net:4222 \
    --protocol-v2 \
    --default
Saved token to development/server/provisioning.jwt, use &#39;choria jwt view development/server/provisioning.jwt&#39; to view it

[choria@issuer ~]$ choria jwt development/server/provisioning.jwt
Unvalidated Provisioning Token development/server/provisioning.jwt

                         Token: *****
                        Secure: false
                          URLS: nats://broker.example.net:4222
       Provisioning by default: true
      Using version 2 Protocol: true
       Server Version Upgrades: false
               Standard Claims: {
                                  &#34;purpose&#34;: &#34;choria_provisioning&#34;,
                                  &#34;iss&#34;: &#34;Choria Tokens Package v0.99.0.20221210&#34;,
                                  &#34;sub&#34;: &#34;choria_provisioning&#34;,
                                  &#34;nbf&#34;: 1670850426,
                                  &#34;iat&#34;: 1670850426,
                                  &#34;jti&#34;: &#34;60a2973b10304184b997f9ea50eeb7a4&#34;
                                }
</code></pre><p>Copy this to your host before running the server. We need to mount this token into the server containers, no other configuration is needed:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ docker run -ti --rm \
      --network choria_v2proto \ 
      --hostname server.example.net \
      -v `pwd`/provisioning.jwt:/etc/choria/provisioning.jwt \
      registry.choria.io/choria-nightly/choria:nightly server run --config /etc/choria/server.conf
</code></pre><p>The server will now start and connect to the Broker, communicate with the Provisioner and restart itself. After restart
the client (configured next) will be able to communicate with it.</p><p>Previously we had to use <code>choria jwt keys</code> and <code>choria jwt server</code> to create Private keys and to issue a signed JWT and then manually transfer that to the Server and configure the Server. This all happens under Choria Provisioner control and takes just a few milliseconds. The only site-unique part about a machine is now the <code>provisioner.jwt</code> that is shared by your fleet, so it&rsquo;s easily placed there during base image build or configuration management. You could issue node-unique <code>provisioning.jwt</code> files with extended information in them and in your <code>helper.rb</code> perform additional validation if you needed that much control.</p><h4 id=aaa-service>AAA Service</h4><p>To provide a self-service system for Clients configure the <a href=https://choria-io.github.io/aaasvc/ target=_blank>Choria AAA Service</a>. Here we will configure it to both issue JWTs and Sign individual requests - meaning it&rsquo;s required to be available for every RPC request. The signing part is optional though, and we could skip that, using it only to obtain JWT tokens.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>We will not delve much into the AAA Service configuration details, <a href=https://choria-io.github.io/aaasvc/configuration/org-issuer/ target=_blank>visit its documentation site</a> for details.</p></div></div><p>We need to issue 3 sets of credentials here:</p><ul><li>One to sign users who request their JWT using <code>choria login</code> called the <em>Chain Signer</em>, since this is HTTP it also needs a x509 certificate</li><li>One to sign RPC requests on behalf of users after evaluating policies and auditing requests called the <em>Request Signer</em></li><li>One to connect to Choria Broker with and run a Choria RPC Service that will receive requests from users to sign their requests called a <em>Signer Service</em>.</li></ul><p>Like the Provisioner the AAA Service container does not have the <code>choria</code> binary, so we need to jump some hoops to make the keys and configuration:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ docker run -ti --rm -v `pwd`/aaasvc:/etc/aaasvc --user root --entrypoint bash registry.choria.io/choria-nightly/choria:nightly -l
[root@38f75c90e475 /]# openssl genrsa -out /etc/aaasvc/https-private.key 2048
Generating RSA private key, 2048 bit long modulus (2 primes)
........................................................................................+++++
...................................+++++
[root@38f75c90e475 /]# openssl req -new -x509 -sha256 -key /etc/aaasvc/https-private.key -out /etc/aaasvc/https-public.crt -days 365 -subj &#34;/O=Choria.io/CN=aaa.choria.local&#34;
[root@38f75c90e475 /]# choria jwt keys /etc/aaasvc/chain-signer-private.key /etc/aaasvc/chain-signer-public.key
Public Key: 17807f2c5fa959383ee5851813863426525c081f6464556e5dec482e815caded

Ed25519 seed saved in /etc/aaasvc/chain-signer-private.key
</code></pre><p>We create a self-signed x509 certificate since the Authentication service runs over HTTPS, you can use any certificate for this.</p><p>Further we create a key used to sign JWTs for users running <code>choria login</code>, it needs a special JWT:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ mkdir -p development/aaasvc
[choria@issuer ~]$ choria jwt client development/aaasvc/chain-signer.jwt aaa_chain_signer \
    development/issuer/private.key \
    --public-key  17807f2c5fa959383ee5851813863426525c081f6464556e5dec482e815caded \
    --no-fleet-management \
    --issuer \
    --validity 365d
Saved token to client development/aaasvc/chain-signer.jwt, use &#39;choria jwt view client development/aaasvc/chain-signer.jwt&#39; to view it
</code></pre><p>Copy this file to the temporary AAA container above as <code>/etc/aaasvc/chain-signer.jwt</code>.</p><p>Next we create the credentials that will sign every RPC request:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ docker run -ti --rm -v `pwd`/aaasvc:/etc/aaasvc --user root --entrypoint bash registry.choria.io/choria-nightly/choria:nightly -l
[root@38f75c90e475 /]# choria jwt keys /etc/aaasvc/request-signer-private.key /etc/aaasvc/reqeuest-signer-public.key
Public Key: 535e9d337e555b9bf9079269567b8d9cb812fdf54797e5d5441ed778f1db68d8

Ed25519 seed saved in /etc/aaasvc/request-signer-private.key
</code></pre><p>This is the key used to sign individual user RPC requests on their behalf, it needs a special JWT:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ mkdir -p development/aaasvc
[choria@issuer ~]$ choria jwt client development/aaasvc/request-signer.jwt aaa_request_signer \
    development/issuer/private.key \
    --public-key 535e9d337e555b9bf9079269567b8d9cb812fdf54797e5d5441ed778f1db68d8 \
    --no-fleet-management \
    --auth-delegation \
    --validity 365d
Saved token to development/aaasvc/request-signer.jwt, use &#39;choria jwt view development/aaasvc/request-signer.jwt&#39; to view it
</code></pre><p>Place it in <code>/etc/aaasvc/request-signer.jwt</code> on the AAA Service container above.</p><p>Finally, we need to create the credentials that allow the request signer to run as a Choria Service.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>host$ docker run -ti --rm -v `pwd`/aaasvc:/etc/aaasvc --user root --entrypoint bash registry.choria.io/choria-nightly/choria:nightly -l
[root@38f75c90e475 /]# choria jwt keys /etc/aaasvc/signer-service-private.key /etc/aaasvc/signer-service-public.key
Public Key: c5c1323f66bb8324d019249e3476d9f11f9deb70efa60255593dde30ef3b8a01

Ed25519 seed saved in /etc/aaasvc/signer-service-private.key
</code></pre><p>Let&rsquo;s create the <code>server</code> JWT that will host the RPC Service for signing requests</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>[choria@issuer ~]$ choria jwt server development/aaasvc/signer-service.jwt \
    aaa.example.net \
    c5c1323f66bb8324d019249e3476d9f11f9deb70efa60255593dde30ef3b8a01 \
    development/issuer/private.key \
    --org choria \
    --collectives choria \
    --service \
    --validity 365d
</code></pre><p>Place it in <code>/etc/aaasvc/signer-service.jwt</code> on the AAA Service container above.</p><p>We can now configure the various parts of the AAA Service, it needs a <code>/etc/aaasvc/choria.conf</code> to connect to the network with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>identity</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>aaa.example.net</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>choria</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.seed_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/aaasvc/signer-service-private.key</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.security.choria.token_file</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/etc/aaasvc/signer-service.jwt</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.middleware_hosts</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>broker.example.net:4222</span>
</span></span></code></pre></div><p>We need an <code>/etc/aaasvc/aaasvc.conf</code>:</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>See the <a href=https://choria-io.github.io/aaasvc/configuration/userlist/index.html target=_blank>User List Authenticator docs</a> about user, passwords and more. The passwords below are all <code>secret</code>.</p></div></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;choria_config&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/choria.conf&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;logfile&#34;</span>: <span style=color:#e6db74>&#34;/dev/stdout&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;loglevel&#34;</span>: <span style=color:#e6db74>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authenticator&#34;</span>: <span style=color:#e6db74>&#34;userlist&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;authorizer&#34;</span>: <span style=color:#e6db74>&#34;opa&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;signer&#34;</span>: <span style=color:#e6db74>&#34;basicjwt&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;monitor_port&#34;</span>: <span style=color:#ae81ff>8081</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;site&#34;</span>: <span style=color:#e6db74>&#34;PREVIEW&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/https-public.crt&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tls_key&#34;</span>:<span style=color:#e6db74>&#34;/etc/aaasvc/https-private.key&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;port&#34;</span>:<span style=color:#ae81ff>8080</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;basicjwt_signer&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_certificate&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/chain-signer-public.key&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/request-signer.jwt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_seed&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/request-signer-private.key&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max_validity&#34;</span>:<span style=color:#e6db74>&#34;2h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;choria_service&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;userlist_authenticator&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_key&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/chain-signer-private.key&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;signing_token&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/chain-signer.jwt&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;validity&#34;</span>: <span style=color:#e6db74>&#34;1h&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;users&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;$2a$05$zQIl4gUZbqmKhpQhIeWx3uDWhAZaHoG34zW1ZsxXQt5xpL5f4uyny&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;opa_policy_file&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/admin.rego&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;broker_permissions&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;org_admin&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;system_user&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;signed_fleet_management&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;streams&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;$2a$05$zQIl4gUZbqmKhpQhIeWx3uDWhAZaHoG34zW1ZsxXQt5xpL5f4uyny&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;broker_permissions&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;streams_admin&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;choria&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;$2a$05$zQIl4gUZbqmKhpQhIeWx3uDWhAZaHoG34zW1ZsxXQt5xpL5f4uyny&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;opa_policy_file&#34;</span>: <span style=color:#e6db74>&#34;/etc/aaasvc/admin.rego&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;broker_permissions&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;signed_fleet_management&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>See the <a href=https://choria-io.github.io/aaasvc/configuration/opa/ target=_blank>AAA Service Docs</a> for writing real policies.</p></div></div><p>Finally, we create an Open Policy Agent policy for the Choria Users, this one just allows everything. Place it in <code>/etc/aaasvc/admin.rego</code></p><pre tabindex=0><code class=language-opa data-lang=opa>package io.choria.aaasvc

default allow = true
</code></pre><p>We can now start the AAA Service:</p><pre tabindex=0><code class=language-nohightlight data-lang=nohightlight>host$ sudo chown -R 2048:2048 aaasvc
host$ docker run -ti --rm \
    -v `pwd`/aaasvc:/etc/aaasvc \
    --network choria_v2proto \
    --hostname aaa.example.net \
    choria/aaasvc:nightly run --config /etc/aaasvc/aaasvc.conf 
</code></pre><h4 id=client>Client</h4><p>Choria Clients will now enroll using <code>choria login</code> which will issue them a 1-hour valid JWT with their policies and more embedded.</p><p>Lets create a new client container:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ docker run -ti --rm --entrypoint bash \
      --network choria_v2proto \
      --hostname client.example.net \
      registry.choria.io/choria-nightly/choria:nightly -l
</code></pre><p>We create a system-wide client configuration in <code>/etc/choria/client.conf</code>:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>loglevel = warn
plugin.choria.middleware_hosts = broker.example.net:4222
plugin.choria.network.system.user = system
plugin.choria.network.system.password = sYst3m

plugin.security.provider = choria
plugin.security.choria.token_file = ~/.config/choria/client.jwt
plugin.security.choria.seed_file = ~/.config/choria/client.key
plugin.choria.security.request_signer.service = true
plugin.login.aaasvc.login.url = https://aaa.example.net:8080/choria/v1/login
</code></pre><p>Users can now run <code>choria login</code> and authenticate using on of the usernames and the password <code>secret</code>.</p><p>The client is now entirely self-service, the token expires every hour, and they just run <code>choria login</code> again. They can do this on as many machines as they have and admins do not get involved.</p><p>Every RPC request the client makes will be signed by the AAA Service after Authorization against the OPA Policy and auditing the outcome. Servers will also validate the OPA policy before executing anything.</p><h3 id=vault-as-organization-issuer>Vault as Organization Issuer</h3><p>We support using <a href=https://www.vaultproject.io/ target=_blank>Hashicorp Vault</a> as the Organization Issuer. In that mode the Private Key is created inside Vault and never has to leave Vault at all.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Here we&rsquo;ll show the developer mode Vault you should use a Production deployment of Vault and not a simple developer local build.</p></div></div><h4 id=starting-vault>Starting Vault</h4><p>We start Vault in dev mode with a static secret defined:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ vault server -dev -dev-root-token-id root
==&gt; Vault server configuration:

             Api Address: http://127.0.0.1:8200
                     Cgo: disabled
         Cluster Address: https://127.0.0.1:8201
....
WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory
and starts unsealed with a single unseal key. The root token is already
authenticated to the CLI, so you can immediately begin using Vault.

You may need to set the following environment variables:

    $ export VAULT_ADDR=&#39;http://127.0.0.1:8200&#39;

The unseal key and root token are displayed below in case you want to
seal/unseal the Vault or re-authenticate.

Unseal Key: JKyF70iBqv3d9rreY9rhY0/EQ9ornriTZHV+kVWpJ+w=
Root Token: root

Development mode should NOT be used in production installations!
</code></pre><h4 id=configuring-the-transit-secrets-engine>Configuring the Transit Secrets Engine</h4><p>Choria relies on the <a href=https://developer.hashicorp.com/vault/docs/secrets/transit target=_blank>Transit Secrets Engine</a> to offload signing of keys.</p><p>Let&rsquo;s enable that:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ export VAULT_ADDR=&#39;http://127.0.0.1:8200
$ export VAULT_TOKEN=&#39;root&#39;
$ vault secrets enable transit
Success! Enabled the transit secrets engine at: transit/
</code></pre><h4 id=create-the-issuer>Create the Issuer</h4><p>We use the Vault API to create an <code>ed25519</code> key stored in Vault storage:</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ export VAULT_ADDR=&#39;http://127.0.0.1:8200
$ export VAULT_TOKEN=&#39;root&#39;
$ vault write transit/keys/choria_issuer type=ed25519
Success! Data written to: transit/keys/choria_issuer
$ vault read transit/keys/choria_issuer
Key                       Value
---                       -----
allow_plaintext_backup    false
auto_rotate_period        0s
deletion_allowed          false
derived                   false
exportable                false
imported_key              false
keys                      map[1:map[creation_time:2022-12-12T11:21:23.248802439+01:00 name:ed25519 public_key:IZu6TyYAwWeuyD3Q0tEiCGbYBjkRjoOcWO/OI9PDmOE=]]
latest_version            1
min_available_version     0
min_decryption_version    1
min_encryption_version    0
name                      choria_issuer
supports_decryption       false
supports_derivation       true
supports_encryption       false
supports_signing          true
type                      ed25519
</code></pre><p>Here we see that the public key is shown as <code>public_key:IZu6TyYAwWeuyD3Q0tEiCGbYBjkRjoOcWO/OI9PDmOE=</code>, lets turn that into a hex encoded string:</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>If saving the public key to a file ensure there is no trailing new line</p></div></div><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ echo IZu6TyYAwWeuyD3Q0tEiCGbYBjkRjoOcWO/OI9PDmOE=|base64 -d|xxd -p -c 64
219bba4f2600c167aec83dd0d2d1220866d80639118e839c58efce23d3c398e1
</code></pre><p>This is the Organization Issuer you configure in your broker and elsewhere.</p><h4 id=signing-jwts-using-vault>Signing JWTs using Vault</h4><p>The <code>choria jwt</code> commands support the <code>--vault</code> flag that requires <code>VAULT_ADDR</code> and <code>VAULT_TOKEN</code> to be set in environment.</p><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria jwt server \
    token.jwt \
    server.example.net \
    3f2d5d01f3c5caa0cd7359512c7e2d9a727fa0392f47f50adee1866bf02cbe12 \
    choria_issuer \
    --collectives=choria \
    --vault
</code></pre><p>Here we pass <code>--vault</code> and instead of a path to the Issuer Private Key we give the name <code>choria_issuer</code> that we created in Vault.</p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://choria-io.github.io/go-choria/logo.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script>var contentLangs=[]</script><script src=https://choria-io.github.io/go-choria/js/auto-complete.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/lunr/lunr.min.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/lunr/lunr.stemmer.support.min.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/lunr/lunr.multi.min.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/search.js?1681207470 defer></script></div><div id=content-wrapper class=highlightable><ul class="topics enlarge morespace"><li data-nav-id=/broker/index.html><a class=padding href=https://choria-io.github.io/go-choria/broker/index.html><b>1. </b>Choria Broker</a><ul id=subsections-dfbddd42a1cd83043778d347f4552a1e class=morespace><li data-nav-id=/broker/monitoring/index.html><a class=padding href=https://choria-io.github.io/go-choria/broker/monitoring/index.html><b>1. </b>Monitoring</a></li></ul></li><li data-nav-id=/server/index.html><a class=padding href=https://choria-io.github.io/go-choria/server/index.html><b>2. </b>Choria Server</a><ul id=subsections-4c6fcb62c73c779f9a17e7db39822c85 class=morespace><li data-nav-id=/server/monitoring/index.html><a class=padding href=https://choria-io.github.io/go-choria/server/monitoring/index.html><b>1. </b>Monitoring</a></li></ul></li><li data-nav-id=/installation/index.html><a class=padding href=https://choria-io.github.io/go-choria/installation/index.html><b>3. </b>Installation</a></li><li data-nav-id=/configuration/index.html><a class=padding href=https://choria-io.github.io/go-choria/configuration/index.html><b>4. </b>Config Reference</a></li><li data-nav-id=/adr/index.html><a class=padding href=https://choria-io.github.io/go-choria/adr/index.html><b>5. </b>Architecture</a><ul id=subsections-55dd4997ce122937146cb3b0f5ba2d2d class=morespace><li data-nav-id=/adr/001/index.html><a class=padding href=https://choria-io.github.io/go-choria/adr/001/index.html><b>1. </b>V2 Network Protocol</a></li></ul></li><li data-nav-id=/packaging/index.html><a class=padding href=https://choria-io.github.io/go-choria/packaging/index.html><b>6. </b>Custom Packaging</a></li><li data-nav-id=/previews/index.html class=parent><a class=padding href=https://choria-io.github.io/go-choria/previews/index.html><b>7. </b>Tech Previews</a><ul id=subsections-c322ebf88a778ba74af3e7821cdcadaa class=morespace><li data-nav-id=/previews/protov2/index.html class=active><a class=padding href=https://choria-io.github.io/go-choria/previews/protov2/index.html><b>1. </b>V2 Protocol & Security</a></li></ul></li></ul><div id=shortcuts><div class="nav-title padding">More</div><ul class=space><li><a class=padding href=https://github.com/choria-io/go-choria><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/general/discussions><i class="far fa-comments"></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/go-choria/issues><i class="far fa-life-ring"></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class="fab fa-slack"></i> #choria</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=choria-relearn value=choria-relearn selected>Choria Relearn</option></select></div><div class=select-clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><button class=padding onclick=clearHistory()><i class="fas fa-history fa-fw"></i><span>&nbsp;</span>Clear History</button></li></ul></div><div id=footer class="footerFooter showFooter"><style>#footer{font-size:13px;height:100px;margin-left:auto;margin-right:auto;padding:2rem 1rem;text-align:center;min-width:230px;max-width:300px}#footer p{margin:0}</style><p>Hosted at <a href=https://github.com/choria-io>GitHub</a> by <a href=https://www.devco.net/>R.I. Pienaar</a></p></div></div></aside><script src=https://choria-io.github.io/go-choria/js/clipboard.min.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/perfect-scrollbar.min.js?1681207470 defer></script>
<script src=https://choria-io.github.io/go-choria/js/theme.js?1681207470 defer></script></body></html>