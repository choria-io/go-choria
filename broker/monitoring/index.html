<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.124.1"><meta name=generator content="Relearn 5.27.0"><meta name=description content><meta name=author content="Choria Project"><meta name=twitter:card content="summary"><meta name=twitter:title content="Monitoring :: Choria Server and Broker"><meta name=twitter:description content><meta property="og:url" content="https://choria-io.github.io/go-choria/broker/monitoring/index.html"><meta property="og:site_name" content="Choria Server and Broker"><meta property="og:title" content="Monitoring :: Choria Server and Broker"><meta property="og:description" content="Choria Broker is just one process running in your server, the command systemctl status choria-broker will show a basic overview of the process running, you should have basic monitoring for the process in place.
Prometheus Metrics By default, the broker does not expose any monitoring metrics, if you set the plugin.choria.stats_port configuration to a port number it will listen on that port. You can listen on non localhost by setting plugin."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><title>Monitoring :: Choria Server and Broker</title>
<link href=https://choria-io.github.io/go-choria/broker/monitoring/index.xml rel=alternate type=application/rss+xml title="Monitoring :: Choria Server and Broker"><link href=https://choria-io.github.io/go-choria/css/fontawesome-all.min.css?1722280025 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/fontawesome-all.min.css?1722280025 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/nucleus.css?1722280025 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/auto-complete.css?1722280025 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/auto-complete.css?1722280025 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/perfect-scrollbar.min.css?1722280025 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/fonts.css?1722280025 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/go-choria/css/fonts.css?1722280025 rel=stylesheet></noscript><link href=https://choria-io.github.io/go-choria/css/theme.css?1722280025 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/theme-choria-relearn.css?1722280025 rel=stylesheet id=R-variant-style><link href=https://choria-io.github.io/go-choria/css/chroma-relearn-light.css?1722280025 rel=stylesheet id=R-variant-chroma-style><link href=https://choria-io.github.io/go-choria/css/variant.css?1722280025 rel=stylesheet><link href=https://choria-io.github.io/go-choria/css/print.css?1722280025 rel=stylesheet media=print><link href=https://choria-io.github.io/go-choria/css/ie.css?1722280025 rel=stylesheet><script src=https://choria-io.github.io/go-choria/js/url.js?1722280025></script><script src=https://choria-io.github.io/go-choria/js/variant.js?1722280025></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://choria-io.github.io/go-choria",window.index_js_url="https://choria-io.github.io/go-choria/index.search.js",window.relearn.themeVariantModifier="",window.variants&&variants.init(["choria-relearn"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=https://choria-io.github.io/go-choria/broker/monitoring/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#prometheus-metrics>Prometheus Metrics</a></li><li><a href=#system-account>System Account</a></li><li><a href=#included-checks>Included Checks</a></li><li><a href=#reports>Reports</a><ul><li><a href=#list-brokers-in-the-cluster>List Brokers in the cluster</a></li><li><a href=#broker-connections>Broker Connections</a></li><li><a href=#streams-report>Streams Report</a></li><li><a href=#details-broker-data>Details Broker Data</a></li></ul></li><li><a href=#golang-profiling>Golang Profiling</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/go-choria/broker/index.html><span itemprop=name>Choria Broker</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Monitoring</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=https://choria-io.github.io/go-choria/broker/index.html title="Choria Broker (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=https://choria-io.github.io/go-choria/server/index.html title="Choria Server (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=monitoring>Monitoring</h1><p>Choria Broker is just one process running in your server, the command <code>systemctl status choria-broker</code> will show a basic
overview of the process running, you should have basic monitoring for the process in place.</p><h2 id=prometheus-metrics>Prometheus Metrics</h2><p>By default, the broker does not expose any monitoring metrics, if you set the <code>plugin.choria.stats_port</code> configuration
to a port number it will listen on that port. You can listen on non localhost by setting <code>plugin.choria.stats_address</code>.</p><p>It will then serve a number of URLs, some from Choria and some from the embedded NATS Server - see <a href=https://docs.nats.io/running-a-nats-service/nats_admin/monitoring rel=external target=_blank>NATS Monitoring</a> for detail about those.</p><table><thead><tr><th>Path</th><th>Description</th></tr></thead><tbody><tr><td><code>/choria/</code></td><td>Build information, run-time resource use</td></tr><tr><td><code>/choria/metrics</code></td><td>Prometheus format metrics</td></tr></tbody></table><h2 id=system-account>System Account</h2><p>Monitoring NATS and Choria Streams require a System account enabled:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.system.user</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>system</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.system.password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>s3cret</span></span></span></code></pre></div><p>This should be set in the Broker configuration and any client who wish to access the broker.</p><p>We have a <a href=https://grafana.com/grafana/dashboards/12430-choria-broker/ rel=external target=_blank>basic Dashboard</a> you can use to view these.</p><h2 id=included-checks>Included Checks</h2><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>All the <code>choria broker server</code> commands are from the embedded <a href=https://github.com/nats-io/natscli rel=external target=_blank>NATS CLI</a> and so can be an awkward fit within our CLI hierarchy</p></div></div><p>We include a number of checks in the binary that can be used to monitor various aspects of the service.</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>choria broker server check connection</code></td><td>Performs a basic network connection and round-trip test of the NATS service</td></tr><tr><td><code>choria broker server check stream</code></td><td>Checks the health of individual <a href=https://choria.io/docs/streams/ rel=external target=_blank>Choria Streams</a> Streams</td></tr><tr><td><code>choria broker server check meta</code></td><td>Checks the health of the overall Choria Streams System</td></tr><tr><td><code>choria broker server check jetstream</code></td><td>Checks Choria Streams usage limits</td></tr><tr><td><code>choria broker server check server</code></td><td>Checks the health of the embedded NATS Server</td></tr><tr><td><code>choria broker server check kv</code></td><td>Checks the health of <a href=https://choria.io/docs/streams/key-value/ rel=external target=_blank>Choria Key-Value</a> buckets</td></tr></tbody></table><p>All of these Checks require the System Account to be enabled in your broker and the client configuration to have the same settings.
A custom Choria Client configuration can be set using <code>--choria-config</code> on these commands.</p><p>By default, these commands act like Nagios checks:</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>% choria broker server check js
OK JetStream | memory=0B memory_pct=0%;75;90 storage=1942997776B storage_pct=0%;75;90 streams=13 streams_pct=0% consumers=21 consumers_pct=0%
% echo $?
0</code></pre></div><p>They can though also output <code>json</code>, <code>prometheus</code> and <code>text</code> formats:</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>% choria broker server check js --format text
JetStream: OK

Check Metrics

╭───────────────┬───────────────┬──────┬────────────────────┬───────────────────╮
│ Metric        │ Value         │ Unit │ Critical Threshold │ Warning Threshold │
├───────────────┼───────────────┼──────┼────────────────────┼───────────────────┤
│ memory        │ 0.00          │ B    │ 0.00               │ 0.00              │
│ memory_pct    │ 0.00          │ %    │ 90.00              │ 75.00             │
│ storage       │ 1942955289.00 │ B    │ 0.00               │ 0.00              │
│ storage_pct   │ 0.00          │ %    │ 90.00              │ 75.00             │
│ streams       │ 13.00         │      │ 0.00               │ 0.00              │
│ streams_pct   │ 0.00          │ %    │ -1.00              │ -1.00             │
│ consumers     │ 21.00         │      │ 0.00               │ 0.00              │
│ consumers_pct │ 0.00          │ %    │ -1.00              │ -1.00             │
╰───────────────┴───────────────┴──────┴────────────────────┴───────────────────╯</code></pre></div><h2 id=reports>Reports</h2><p>Several run time reports are included that can show connection states and more, all of these require the System Account.</p><h3 id=list-brokers-in-the-cluster>List Brokers in the cluster</h3><p>This shows all the connected NATS Servers / Choria Brokers in your cluster and some basic information about them</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ choria broker server list</code></pre></div><h3 id=broker-connections>Broker Connections</h3><p>You can view and search active connections to your brokers, here we limit it to the top-5 by subject, see <code>--help</code> for other options</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>% choria broker server report connections --top 5</code></pre></div><p>Add the <code>--account=provisioning</code> option to see connections waiting to be provisioned if enabled.</p><h3 id=streams-report>Streams Report</h3><p>One can get a overview of Choria Streams backends:</p><div class="highlight wrap-code"><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>% choria broker server report jetstream</code></pre></div><h3 id=details-broker-data>Details Broker Data</h3><p>A wealth of data is available in the Brokers about every connection and every subscription and more, run <code>choria broker server req --help</code> to see a full list.</p><h2 id=golang-profiling>Golang Profiling</h2><p>As an advanced option, that should not be enabled by default, one can enable the <a href=https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/ rel=external target=_blank>Golang PProf</a>
port to facilitate deep debugging of memory allocations and more. How to use this is out of scope of this document and
really only useful for developers.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>plugin.choria.network.pprof_port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>9090</span></span></span></code></pre></div><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><img src=https://choria-io.github.io/go-choria/logo.png></div><search><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></search><script>var contentLangs=[]</script><script src=https://choria-io.github.io/go-choria/js/auto-complete.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/lunr/lunr.min.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/lunr/lunr.stemmer.support.min.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/lunr/lunr.multi.min.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/search.js?1722280025 defer></script></div><div id=R-homelinks class=default-animation><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/broker/index.html class=parent><a class=padding href=https://choria-io.github.io/go-choria/broker/index.html><b>1. </b>Choria Broker</a><ul id=R-subsections-c0d38400b06e01717dd02c1b81bf71f9 class="morespace collapsible-menu"><li data-nav-id=/broker/monitoring/index.html class=active><a class=padding href=https://choria-io.github.io/go-choria/broker/monitoring/index.html><b>1. </b>Monitoring</a></li></ul></li><li data-nav-id=/server/index.html><a class=padding href=https://choria-io.github.io/go-choria/server/index.html><b>2. </b>Choria Server</a><ul id=R-subsections-5ee5c6bb7d28a6dec29b86cffcb6fc0d class="morespace collapsible-menu"><li data-nav-id=/server/monitoring/index.html><a class=padding href=https://choria-io.github.io/go-choria/server/monitoring/index.html><b>1. </b>Monitoring</a></li></ul></li><li data-nav-id=/installation/index.html><a class=padding href=https://choria-io.github.io/go-choria/installation/index.html><b>3. </b>Installation</a></li><li data-nav-id=/configuration/index.html><a class=padding href=https://choria-io.github.io/go-choria/configuration/index.html><b>4. </b>Config Reference</a></li><li data-nav-id=/adr/index.html><a class=padding href=https://choria-io.github.io/go-choria/adr/index.html><b>5. </b>Architecture</a><ul id=R-subsections-55d689b2e177bef7553c466a890920c2 class="morespace collapsible-menu"><li data-nav-id=/adr/001/index.html><a class=padding href=https://choria-io.github.io/go-choria/adr/001/index.html><b>1. </b>V2 Network Protocol</a></li></ul></li><li data-nav-id=/packaging/index.html><a class=padding href=https://choria-io.github.io/go-choria/packaging/index.html><b>6. </b>Custom Packaging</a></li><li data-nav-id=/previews/index.html><a class=padding href=https://choria-io.github.io/go-choria/previews/index.html><b>7. </b>Tech Previews</a><ul id=R-subsections-a62187002d34d68923160090a7e2de50 class="morespace collapsible-menu"><li data-nav-id=/previews/protov2/index.html><a class=padding href=https://choria-io.github.io/go-choria/previews/protov2/index.html><b>1. </b>V2 Protocol & Security</a></li></ul></li></ul></div><div id=R-shortcuts><div class="nav-title padding">More</div><ul class=space><li><a class=padding href=https://github.com/choria-io/go-choria><i class='fab fa-fw fa-github'></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/general/discussions><i class='far fa-comments'></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/go-choria/issues><i class='far fa-life-ring'></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class='fab fa-slack'></i> #choria</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Language</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"><option id=R-select-language-en value=#R-select-language-en data-url=https://choria-io.github.io/go-choria/broker/monitoring/index.html lang=en-us selected></option></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-choria-relearn value=choria-relearn selected>Choria Relearn</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><style>#footer{font-size:13px;height:100px;margin-left:auto;margin-right:auto;padding:2rem 1rem;text-align:center;min-width:230px;max-width:300px}#footer p{margin:0}</style><p>Hosted at <a href=https://github.com/choria-io>GitHub</a> by <a href=https://www.devco.net/>R.I. Pienaar</a></p></div></div></div></aside><script src=https://choria-io.github.io/go-choria/js/clipboard.min.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/perfect-scrollbar.min.js?1722280025 defer></script><script src=https://choria-io.github.io/go-choria/js/theme.js?1722280025 defer></script></body></html>